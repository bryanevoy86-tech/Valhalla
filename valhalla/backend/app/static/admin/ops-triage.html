<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Valhalla — Ops Triage</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  :root { color-scheme: dark; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b0f14; color:#e6edf3; margin:16px;}
  .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; }
  .card { background:#0f1420; border:1px solid #1e2630; border-radius:14px; padding:14px; box-shadow: 0 1px 0 #000 inset;}
  .title { font-weight:600; font-size:14px; opacity:.9; margin-bottom:8px; }
  .big { font-size:28px; font-weight:700; }
  .pill { padding:2px 8px; border-radius:999px; background:#13202e; border:1px solid #243040; font-size:12px; }
  .warn { border-color:#ff922b; color:#ffd8a8; }
  .crit { border-color:#ff6b6b; color:#ffc9c9; }
  .ok { color:#8ce99a }
  table { width:100%; border-collapse:collapse; }
  th, td { text-align:left; padding:6px 4px; border-bottom:1px solid #1e2630; font-size:13px; }
  a { color:#91c9ff; text-decoration:none; }
  .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  .muted { opacity:.7; font-size:12px; }
  button { padding:8px 10px; border-radius:10px; background:#112033; color:#cce4ff; border:1px solid #243040; cursor:pointer;}
  button:hover { background:#0f1a29; }
</style>
</head>
<body>
  <div class="row">
    <h2 style="margin:0;">Ops Triage</h2>
    <span id="ts" class="muted"></span>
    <div style="flex:1"></div>
    <button id="refresh">Refresh</button>
    <a id="grafana" class="pill" target="_blank" style="display:none">Grafana</a>
    <a id="tempo" class="pill" target="_blank" style="display:none">Tempo</a>
  </div>

  <div class="grid" style="margin-top:12px">
    <div class="card">
      <div class="title">RPS</div>
      <div class="big" id="rps">—</div>
    </div>
    <div class="card">
      <div class="title">Errors / sec</div>
      <div class="big" id="err">—</div>
    </div>
    <div class="card">
      <div class="title">p95 latency (s)</div>
      <div class="big" id="p95">—</div>
    </div>
    <div class="card">
      <div class="title">Active jobs</div>
      <div class="big" id="jobs">—</div>
    </div>
  </div>

  <div class="grid" style="margin-top:12px">
    <div class="card">
      <div class="row"><div class="title">Top 5xx paths</div><a id="top5xx_link" class="muted" target="_blank">open</a></div>
      <table><thead><tr><th>Path</th><th>5xx/s</th></tr></thead><tbody id="top5xx"></tbody></table>
    </div>
    <div class="card">
      <div class="row"><div class="title">Slowest p95 paths</div><a id="slow_link" class="muted" target="_blank">open</a></div>
      <table><thead><tr><th>Path</th><th>p95 (s)</th></tr></thead><tbody id="slow"></tbody></table>
    </div>
    <div class="card">
      <div class="row"><div class="title">Job failures (rps)</div></div>
      <table><thead><tr><th>Job</th><th>err/s</th></tr></thead><tbody id="jobfails"></tbody></table>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="row"><div class="title">SLO burn rate</div>
      <span class="pill" id="burn5">5m</span>
      <span class="pill" id="burn30">30m</span>
      <span class="pill" id="burn2h">2h</span>
      <span class="pill" id="burn24">24h</span>
      <a id="p95_link" class="muted" target="_blank" style="margin-left:auto">open p95</a>
      <a id="errors_link" class="muted" target="_blank">open errors</a>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="row"><div class="title">Recent alerts</div><span class="muted" id="an"></span></div>
    <table><thead><tr><th>Alert</th><th>Severity</th><th>State</th><th>Description</th></tr></thead><tbody id="alerts"></tbody></table>
  </div>

<script>
async function load() {
  try {
    const r = await fetch('/admin/ops/summary')
    if(!r.ok){ throw new Error('summary unavailable') }
    const d = await r.json()
    document.getElementById('ts').textContent = new Date(d.ts).toLocaleString()
    // links
    if(d.links?.grafana){ const a=document.getElementById('grafana'); a.href=d.links.grafana; a.style.display='inline-block' }
    if(d.links?.tempo){ const a=document.getElementById('tempo'); a.href=d.links.tempo; a.style.display='inline-block' }
    if(d.links?.explore?.top5xx) document.getElementById('top5xx_link').href = d.links.explore.top5xx
    if(d.links?.explore?.slow) document.getElementById('slow_link').href = d.links.explore.slow
    if(d.links?.explore?.p95) document.getElementById('p95_link').href = d.links.explore.p95
    if(d.links?.explore?.errors) document.getElementById('errors_link').href = d.links.explore.errors

    // overview
    const f = (x)=> (Math.round(x*100)/100).toLocaleString()
    document.getElementById('rps').textContent = f(d.overview.rps || 0)
    document.getElementById('err').textContent = f(d.overview.errors_per_s || 0)
    document.getElementById('p95').textContent = f(d.overview.p95_s || 0)
    document.getElementById('jobs').textContent = f(d.overview.jobs_active || 0)

    // burn rate pills
    function setPill(id,val){ const el=document.getElementById(id); el.textContent = el.textContent.split(' ')[0] + ' ' + f(val); el.classList.remove('warn','crit'); if(val>6) el.classList.add('warn'); if(val>14) el.classList.add('crit') }
    setPill('burn5', d.burn_rates["5m"])
    setPill('burn30', d.burn_rates["30m"])
    setPill('burn2h', d.burn_rates["2h"])
    setPill('burn24', d.burn_rates["24h"])

    // tables
    function rows(elId, items, keyLabel) {
      const el = document.getElementById(elId)
      el.innerHTML = (items||[]).map(it=>`<tr><td class="mono">${it.key||'—'}</td><td>${f(it.value||0)}</td></tr>`).join('')
    }
    rows('top5xx', d.top_5xx_paths, 'path')
    rows('slow', d.slow_p95_paths, 'path')
    rows('jobfails', d.job_failures, 'job_type')

    // alerts
    const al = document.getElementById('alerts')
    document.getElementById('an').textContent = `(${(d.alerts||[]).length})`
    al.innerHTML = (d.alerts||[]).map(a=>{
      const sev = a.severity||'';
      const cls = sev==='critical'?'crit': (sev==='warning'?'warn':'')
      return `<tr>
        <td>${a.name||''}</td>
        <td><span class="pill ${cls}">${sev||''}</span></td>
        <td>${a.state||''}</td>
        <td>${(a.desc||'').replace(/</g,'&lt;')}</td>
      </tr>`
    }).join('')
  } catch(e) {
    alert('Failed to load triage summary: '+e.message)
  }
}
document.getElementById('refresh').onclick = load
load()
</script>
</body>
</html>
