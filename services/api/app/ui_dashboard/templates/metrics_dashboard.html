<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Metrics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
        .card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px 16px; background: #fff; }
        .card h3 { margin: 0 0 8px; font-size: 14px; color: #6b7280; font-weight: 600; }
        .card .value { font-size: 24px; font-weight: 700; }
        canvas { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; }
    </style>
    <script>
        const API_BASE = '/api/ui-dashboard';
        let chart;
        let labels = [];
        let rpsData = [];
        let errRateData = [];
        let p50Data = [];

        async function loadRoleDashboard() {
            const sel = document.getElementById('roleSelect');
            const role = (sel && sel.value) ? sel.value : 'viewer';
            const res = await fetch(`/api/metrics/dashboard/${role}`);
            if (!res.ok) return;
            const data = await res.json();
            const target = document.getElementById('roleDash');
            const info = document.getElementById('roleDashInfo');
            if (target) target.innerText = `Metrics for ${data.role}: ${data.metrics.join(', ')}`;
            if (info) info.innerText = `Last updated: ${data.last_updated}`;
        }

        async function fetchMetrics() {
            const res = await fetch(`${API_BASE}/metrics-dashboard`);
            if (!res.ok) return null;
            return await res.json();
        }

        function updateCards(metrics) {
            document.getElementById('rps').innerText = (metrics.requests_per_sec ?? 0).toFixed(3);
            document.getElementById('err').innerText = (metrics.error_rate ?? 0).toFixed(3);
            document.getElementById('p50').innerText = metrics.p50_latency != null ? metrics.p50_latency.toFixed(3) : '—';
            document.getElementById('total').innerText = metrics.total_requests ?? 0;
            document.getElementById('errors').innerText = metrics.total_errors ?? 0;
        }

        function initChart() {
            const ctx = document.getElementById('metricsChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'RPS', borderColor: 'rgba(37, 99, 235, 1)', backgroundColor: 'rgba(37, 99, 235, 0.2)', data: rpsData, tension: 0.25 },
                        { label: 'Error Rate', borderColor: 'rgba(220, 38, 38, 1)', backgroundColor: 'rgba(220, 38, 38, 0.2)', data: errRateData, tension: 0.25 },
                        { label: 'p50 Latency (s)', borderColor: 'rgba(16, 185, 129, 1)', backgroundColor: 'rgba(16, 185, 129, 0.2)', data: p50Data, tension: 0.25 },
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function pushData(metrics) {
            const ts = new Date().toLocaleTimeString();
            labels.push(ts);
            rpsData.push(metrics.requests_per_sec ?? 0);
            errRateData.push(metrics.error_rate ?? 0);
            p50Data.push(metrics.p50_latency ?? 0);
            // keep last 60 points
            if (labels.length > 60) {
                labels.shift(); rpsData.shift(); errRateData.shift(); p50Data.shift();
            }
            chart.update('none');
        }

        async function poll() {
            const m = await fetchMetrics();
            if (m) { updateCards(m); pushData(m); }
        }

        window.addEventListener('load', async () => {
            initChart();
            await poll();
            setInterval(poll, 2000);
        });
    </script>
    </head>
<body>
    <div class="container">
        <h1>Admin Dashboard: Real-time Metrics</h1>
        <div class="card" style="margin: 12px 0; padding: 12px 16px;">
            <div style="display:flex; gap:8px; align-items:center; flex-wrap: wrap;">
                <label for="roleSelect" style="font-weight:600; color:#6b7280;">Role dashboard:</label>
                <select id="roleSelect">
                    <option value="admin">admin</option>
                    <option value="viewer">viewer</option>
                </select>
                <button onclick="loadRoleDashboard()" style="background:#111827;color:#fff;border:none;border-radius:6px;padding:8px 12px;cursor:pointer;">Load</button>
                <span id="roleDashInfo" style="color:#6b7280; font-size:12px;"></span>
            </div>
            <div id="roleDash" style="margin-top:8px; color:#111827;"></div>
        </div>
        <div class="cards">
            <div class="card"><h3>Requests / sec</h3><div class="value" id="rps">0.000</div></div>
            <div class="card"><h3>Error Rate</h3><div class="value" id="err">0.000</div></div>
            <div class="card"><h3>p50 Latency (s)</h3><div class="value" id="p50">—</div></div>
            <div class="card"><h3>Total Requests</h3><div class="value" id="total">0</div></div>
            <div class="card"><h3>Total Errors</h3><div class="value" id="errors">0</div></div>
        </div>
        <div style="height: 420px;">
            <canvas id="metricsChart"></canvas>
        </div>

        <!-- Pack 22: Activity Tracking Section -->
        <div class="card" style="margin-top: 24px;">
            <h3>User Activity Tracking</h3>
            <div style="display:flex; gap:8px; margin: 12px 0;">
                <input id="userId" placeholder="user_123" style="padding:6px 8px; border:1px solid #e5e7eb; border-radius:6px;" />
                <input id="action" placeholder="login" style="padding:6px 8px; border:1px solid #e5e7eb; border-radius:6px;" />
                <input id="details" placeholder="Successful login" style="padding:6px 8px; border:1px solid #e5e7eb; border-radius:6px; flex-grow:1;" />
                <button onclick="recordActivity()" style="background:#111827;color:#fff;border:none;border-radius:6px;padding:8px 12px;cursor:pointer;">Record Activity</button>
                <button onclick="loadActivities()" style="background:#2563eb;color:#fff;border:none;border-radius:6px;padding:8px 12px;cursor:pointer;">Load Activities</button>
            </div>
            <div id="activityLog" style="max-height:300px; overflow-y:auto; border:1px solid #e5e7eb; border-radius:6px; padding:8px; margin-top:8px; background:#f9fafb;"></div>
        </div>
    </div>
    <script>
        async function recordActivity() {
            const userId = document.getElementById('userId').value || 'user_123';
            const action = document.getElementById('action').value || 'login';
            const details = document.getElementById('details').value || 'Successful login';
            
            const res = await fetch('/api/metrics/track', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ user_id: userId, action: action, details: details })
            });
            
            if (res.ok) {
                const result = await res.json();
                alert(`Activity recorded: ${result.action} for ${result.user_id}`);
                loadActivities();
            } else {
                alert('Failed to record activity');
            }
        }

        async function loadActivities() {
            const res = await fetch('/api/metrics/activities?limit=50');
            if (!res.ok) return;
            
            const activities = await res.json();
            const log = document.getElementById('activityLog');
            log.innerHTML = '';
            
            if (activities.length === 0) {
                log.innerHTML = '<p style="color:#6b7280;">No activities recorded yet.</p>';
                return;
            }
            
            activities.reverse().forEach(activity => {
                const div = document.createElement('div');
                div.style.cssText = 'padding:8px; margin-bottom:4px; background:#fff; border-radius:4px; border-left:3px solid #2563eb;';
                div.innerHTML = `<strong>${activity.action}</strong> - ${activity.user_id} <br/><span style="color:#6b7280; font-size:12px;">${activity.timestamp} - ${activity.details}</span>`;
                log.appendChild(div);
            });
        }
    </script>
</body>
</html>