# Render Blueprint â€” Valhalla API + Worker + Postgres
# Place this file at the repo root and create from "New > Blueprint" in Render.

databases:
  - name: valhalla-prod
    databaseName: valhalla
    user: valhalla_app
    plan: starter
    region: oregon
    ipAllowList: []   # private by default

services:
  - type: web
    name: valhalla-api
    runtime: docker
    plan: starter
    region: oregon
    autoDeploy: true
    dockerfilePath: ./Dockerfile
    dockerContext: .
    dockerCommand: alembic upgrade heads && python start.py
    healthCheckPath: /api/health
    envVars:
      - key: APP_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: valhalla-prod
          property: internalConnectionString
      - key: CORS_ALLOWED_ORIGINS
        # comma-separated list; update after your WeWeb site is published
        value: https://YOUR-WEWEB-DOMAIN
      - key: WEWEB_SHARED_SECRET
        # set the real value in the Render dashboard after first deploy
        value: CHANGE_ME
      # Pack 46: Clone & Mirror Policies
      - key: CLONE_MIN_DAYS_BETWEEN
        value: "7"
      - key: CLONE_MAX_ACTIVE
        value: "12"
      - key: CLONE_REQUIRED_UPTIME_PCT
        value: "98.5"
      - key: CLONE_REQUIRED_CASH_RESERVES
        value: "25000"
      - key: CLONE_REQUIRED_NET_MARGIN_PCT
        value: "18"
      - key: CLONE_REQUIRED_AUDIT_SCORE
        value: "90"
      - key: CLONE_ERROR_RATE_MAX_PPM
        value: "250"

      - key: MIRROR_MIN_DAYS_BETWEEN
        value: "14"
      - key: MIRROR_REQUIRED_TRAFFIC_P90_RPS
        value: "5"
      - key: MIRROR_REQUIRED_LATENCY_P95_MS
        value: "350"
      - key: MIRROR_MAX_ACTIVE
        value: "2"
      # Pack 47: Provider Adapters
      - key: PLAID_CLIENT_ID
        value: your_id
      - key: PLAID_SECRET
        value: your_secret
      - key: PLAID_ENV
        value: sandbox
      
      - key: STRIPE_SECRET_KEY
        value: sk_test_xxx
      - key: STRIPE_WEBHOOK_SECRET
        value: whsec_xxx
      
      - key: DOCUSIGN_INTEGRATOR_KEY
        value: xxxx
      - key: DOCUSIGN_USER_ID
        value: xxxx
      - key: DOCUSIGN_ACCOUNT_ID
        value: xxxx
      - key: DOCUSIGN_BASE_URI
        value: https://demo.docusign.net
      - key: DOCUSIGN_WEBHOOK_SECRET
        value: whsec_docusign_xxx
      
      # Pack 48: Heimdall Behavioral Core
      - key: HEIMDALL_BEHAVIOR_ENABLED
        value: "true"
      - key: HEIMDALL_MIN_CONFIDENCE
        value: "0.5"
      - key: HEIMDALL_MAX_PUSHINESS
        value: "0.8"
      - key: HEIMDALL_DEFAULT_PERSONA
        value: consultant
      
      # Pack 50: Full Accounting Suite
      - key: ACCOUNTING_BASE_CURRENCY
        value: CAD
      - key: ACCOUNTING_FISCAL_YEAR_START
        value: "01-01"
      - key: ACCOUNTING_REPORT_DECIMALS
        value: "2"
      - key: CRA_BOT_ENABLED
        value: "true"
      - key: CRA_SAFE_WRITE_OFF_THRESHOLD
        value: "0.7"
      # Pack 52: Negotiation & Psychology AI Enhancer
      - key: NEG_ENHANCER_ENABLED
        value: "true"
      - key: NEG_MIN_CONF_FOR_REBUTTAL
        value: "0.50"
      - key: NEG_ESCALATE_SCORE
        value: "0.80"
      - key: NEG_MAX_REBUTTAL_LENGTH
        value: "600"
      # Pack 53: Black Ice Tier II + Shadow Contingency
      - key: BLACK_ICE_ENABLED
        value: "true"
      - key: BLACK_ICE_DEFAULT_LEVEL
        value: "2"
      - key: BLACK_ICE_ALERT_CHANNEL
        value: "ops"
      - key: BLACK_ICE_KEY_ROTATE_CHECKLIST
        value: "api,oauth,webhooks,ssh,db,cdn,emails,storage"
      - key: BLACK_ICE_CONTINUITY_MIN_HOURS
        value: "72"
      # Pack 54: Children's Hubs + Vault Guardians
      - key: KIDS_COIN_EXCHANGE_RATE
        value: "0.01"
      - key: KIDS_DEFAULT_SAVE_PCT
        value: "0.20"
      - key: KIDS_INVEST_APR
        value: "0.05"
      - key: KIDS_WEEKLY_DIGEST_DAY
        value: "SUN"
      # Pack 55: Queen's Hub + Fun Fund Vaults
      - key: QUEEN_NAME
        value: "Lanna"
      - key: QUEEN_FUN_CAP_PHASE2
        value: "10000"
      - key: QUEEN_FUN_CAP_PHASE3
        value: "25000"
      - key: QUEEN_TAX_WITHHOLD_RATE
        value: "0.18"
      - key: QUEEN_BASE_CURRENCY
        value: "CAD"
      # Pack 56: King's Hub + Adaptive Vault Scaling
      - key: KING_BASE_CURRENCY
        value: "CAD"
      - key: KING_DEFAULT_RULES_JSON
        value: '{"reinvest_pct":0.90,"fun_pct":0.10,"bahamas_pct":0.00,"reserves_pct":0.00}'
      - key: KING_MIN_RESERVES_TARGET
        value: "25000"
      - key: KING_BAHAMAS_TARGET
        value: "500000"
      - key: KING_BAHAMAS_MIN_MONTHLY
        value: "5000"
      - key: KING_RULE_ADJUST_STEP
        value: "0.05"
      - key: KING_ADAPTIVE_ENABLED
        value: "true"
      # Pack 57: Pantry Photo Inventory System
      - key: PANTRY_DEFAULT_LOCATIONS
        value: "Main Pantry,Deep Freezer,Garage Stock"
      - key: PANTRY_REORDER_DIGEST_DAY
        value: "SUN"
      - key: PANTRY_AUTOREORDER_ENABLED
        value: "true"
      # Pack 58: Resort Vault + Residency Timeline
      - key: RESORT_BASE_CURRENCY
        value: USD
      - key: RESORT_DEFAULT_NAME
        value: Bahamas Phase 1
      - key: RESORT_TARGET_BUDGET
        value: "2500000"
      - key: RESIDENCY_TARGET_DATE
        value: "2027-01-15"
      - key: RESIDENCY_MIN_CAPITAL
        value: "750000"
      - key: RESORT_DIGEST_DAY
        value: MON
      # Pack 59: Integrity Ledger + Telemetry Finalization
      - key: INTEGRITY_HMAC_SECRET
        value: change-me
      - key: TELEMETRY_SAMPLE_RATE
        value: "1.0"
      - key: TELEMETRY_SLA_MS
        value: "800"
      - key: TELEMETRY_ALERT_CHANNEL
        value: ops
      # Pack 60: Tax Optimization & Write-Off Tracker
      - key: TAX_TRACKER_ENABLED
        value: "true"
      - key: RECEIPT_OCR_PROVIDER
        value: easyocr
      - key: RECEIPT_STORAGE_BUCKET
        value: s3://valhalla-receipts
      - key: RECEIPT_MAX_IMAGE_MB
        value: "20"
      - key: CRA_YEAR
        value: "2025"
      - key: IRS_YEAR
        value: "2025"
      - key: TAX_RISK_THRESHOLD
        value: "0.7"
      - key: WRITEOFF_RULESET_VERSION
        value: "1"
      - key: EXPORT_BUNDLE_TTL_DAYS
        value: "30"
      # Pack 61: Heimdall Intelligence Training & Evolution Core
      - key: HEIMDALL_TRAINING_ENABLED
        value: "true"
      - key: HEIMDALL_EVAL_CRON
        value: "0 3 * * *"
      - key: PROMPT_REGISTRY_VERSION
        value: "1"
      - key: ABTEST_DEFAULT_SPLIT
        value: "50"
      - key: CORPUS_STORAGE_BUCKET
        value: s3://valhalla-corpus
      - key: EVAL_SAMPLE_SIZE
        value: "200"
      - key: FEEDBACK_WEIGHT_DECAY
        value: "0.98"
      # Pack 62: Underwriter Signals & Deal Risk Scoring
      - key: UNDERWRITER_ENABLED
        value: "true"
      - key: COMPS_PROVIDER
        value: manual
      - key: REPAIR_MODEL_PROVIDER
        value: heuristic
      - key: MARKET_BENCHMARK_REGION
        value: MB-WPG
      - key: MIN_TARGET_ROI_PCT
        value: "18"
      - key: MAX_DTI_PCT
        value: "45"
      - key: MAX_LTV_PCT
        value: "75"
      - key: UNDERWRITER_P95_MS
        value: "350"
      # Pack 63: Behavioral Closer Engine & Script Orchestrator
      - key: CLOSER_ENGINE_ENABLED
        value: "true"
      - key: CLOSER_STYLE_DEFAULT
        value: neutral
      - key: CLOSER_MAX_STEP_MINUTES
        value: "5"
      - key: CLOSER_ESCALATE_AFTER_MINUTES
        value: "45"
      - key: CLOSER_VOIP_PROVIDER
        value: none
      - key: CLOSER_NUDGE_COOLDOWN_MIN
        value: "60"
      # Pack 64: Contract Assembly 2.0
      - key: CONTRACT_ENGINE_ENABLED
        value: "true"
      - key: CONTRACT_PDF_PROVIDER
        value: stub
      - key: CONTRACT_ESIGN_PROVIDER
        value: internal
      - key: CONTRACT_DEFAULT_JURISDICTION
        value: MB
      - key: CONTRACT_FALLBACK_LANGUAGE
        value: en
      - key: CONTRACT_SEND_FROM_EMAIL
        value: noreply@valhalla.inc
      - key: CONTRACT_REMINDER_HOURS
        value: "24"
      # Pack 65: Buyer Matching Engine
      - key: BUYER_MATCH_ENABLED
        value: "true"
      - key: BUYER_SCORE_MIN
        value: "60"
      - key: BUYER_MAX_RESULTS
        value: "25"
      - key: DEAL_CLAIM_TTL_MIN
        value: "60"
      - key: BUYER_ALERT_COOLDOWN_MIN
        value: "120"
      - key: BUYER_DEFAULT_REGION
        value: MB-WPG
      
      # Builder API configuration
      - key: HEIMDALL_BUILDER_API_KEY
        value: 2af3d998e1b7e2ca882291732aa40dd9
      - key: HEIMDALL_BUILDER
        value: on
      - key: BUILDER_SAFE_MODE
        value: on
      - key: AUTO_DEPLOY
        value: off
      - key: ALLOW_DESTRUCTIVE
        value: off
      - key: HEIMDALL_TELEMETRY_SAMPLING
        value: "0.2"
      # S3/R2 (optional for exports)
      - key: S3_ENDPOINT
        value: https://YOUR-S3-ENDPOINT
      - key: S3_REGION
        value: us-east-1
      - key: S3_BUCKET
        value: valhalla-exports
      - key: S3_ACCESS_KEY_ID
        value: CHANGE_ME
      - key: S3_SECRET_ACCESS_KEY
        value: CHANGE_ME


  - type: worker
    name: valhalla-worker
    runtime: python
    plan: starter
    region: oregon
    autoDeploy: true
    buildCommand: pip install -r requirements.txt
    startCommand: python -m services.api.export_worker
    envVars:
      - key: APP_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: valhalla-prod
          property: internalConnectionString
      - key: WEWEB_SHARED_SECRET
        value: CHANGE_ME
      - key: S3_ENDPOINT
        value: https://YOUR-S3-ENDPOINT
      - key: S3_REGION
        value: us-east-1
      - key: S3_BUCKET
        value: valhalla-exports
      - key: S3_ACCESS_KEY_ID
        value: CHANGE_ME
      - key: S3_SECRET_ACCESS_KEY
        value: CHANGE_ME
