# Render Blueprint â€” Valhalla API + Worker + Postgres
# Place this file at the repo root and create from "New > Blueprint" in Render.

databases:
  - name: valhalla-prod
    databaseName: valhalla
    user: valhalla_app
    plan: starter
    region: oregon
    ipAllowList: []   # private by default

services:
  - type: web
    name: valhalla-api
    runtime: docker
    plan: starter
    region: oregon
    autoDeploy: true
    dockerfilePath: ./Dockerfile
    dockerContext: .
    dockerCommand: alembic upgrade head && python start.py
    healthCheckPath: /api/health
    envVars:
      - key: APP_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: valhalla-prod
          property: internalConnectionString
      - key: CORS_ALLOWED_ORIGINS
        # comma-separated list; update after your WeWeb site is published
        value: https://YOUR-WEWEB-DOMAIN
      - key: WEWEB_SHARED_SECRET
        # set the real value in the Render dashboard after first deploy
        value: CHANGE_ME
      # Pack 46: Clone & Mirror Policies
      - key: CLONE_MIN_DAYS_BETWEEN
        value: "7"
      - key: CLONE_MAX_ACTIVE
        value: "12"
      - key: CLONE_REQUIRED_UPTIME_PCT
        value: "98.5"
      - key: CLONE_REQUIRED_CASH_RESERVES
        value: "25000"
      - key: CLONE_REQUIRED_NET_MARGIN_PCT
        value: "18"
      - key: CLONE_REQUIRED_AUDIT_SCORE
        value: "90"
      - key: CLONE_ERROR_RATE_MAX_PPM
        value: "250"

      - key: MIRROR_MIN_DAYS_BETWEEN
        value: "14"
      - key: MIRROR_REQUIRED_TRAFFIC_P90_RPS
        value: "5"
      - key: MIRROR_REQUIRED_LATENCY_P95_MS
        value: "350"
      - key: MIRROR_MAX_ACTIVE
        value: "2"
      # Pack 47: Provider Adapters
      - key: PLAID_CLIENT_ID
        value: your_id
      - key: PLAID_SECRET
        value: your_secret
      - key: PLAID_ENV
        value: sandbox
      
      - key: STRIPE_SECRET_KEY
        value: sk_test_xxx
      - key: STRIPE_WEBHOOK_SECRET
        value: whsec_xxx
      
      - key: DOCUSIGN_INTEGRATOR_KEY
        value: xxxx
      - key: DOCUSIGN_USER_ID
        value: xxxx
      - key: DOCUSIGN_ACCOUNT_ID
        value: xxxx
      - key: DOCUSIGN_BASE_URI
        value: https://demo.docusign.net
      - key: DOCUSIGN_WEBHOOK_SECRET
        value: whsec_docusign_xxx
      
      # Pack 48: Heimdall Behavioral Core
      - key: HEIMDALL_BEHAVIOR_ENABLED
        value: "true"
      - key: HEIMDALL_MIN_CONFIDENCE
        value: "0.5"
      - key: HEIMDALL_MAX_PUSHINESS
        value: "0.8"
      - key: HEIMDALL_DEFAULT_PERSONA
        value: consultant
      
      # Pack 50: Full Accounting Suite
      - key: ACCOUNTING_BASE_CURRENCY
        value: CAD
      - key: ACCOUNTING_FISCAL_YEAR_START
        value: "01-01"
      - key: ACCOUNTING_REPORT_DECIMALS
        value: "2"
      - key: CRA_BOT_ENABLED
        value: "true"
      - key: CRA_SAFE_WRITE_OFF_THRESHOLD
        value: "0.7"
      
      # Builder API configuration
      - key: HEIMDALL_BUILDER_API_KEY
        value: 2af3d998e1b7e2ca882291732aa40dd9
      - key: HEIMDALL_BUILDER
        value: on
      - key: BUILDER_SAFE_MODE
        value: on
      - key: AUTO_DEPLOY
        value: off
      - key: ALLOW_DESTRUCTIVE
        value: off
      - key: HEIMDALL_TELEMETRY_SAMPLING
        value: "0.2"
      # S3/R2 (optional for exports)
      - key: S3_ENDPOINT
        value: https://YOUR-S3-ENDPOINT
      - key: S3_REGION
        value: us-east-1
      - key: S3_BUCKET
        value: valhalla-exports
      - key: S3_ACCESS_KEY_ID
        value: CHANGE_ME
      - key: S3_SECRET_ACCESS_KEY
        value: CHANGE_ME


  - type: worker
    name: valhalla-worker
    runtime: python
    plan: starter
    region: oregon
    autoDeploy: true
    buildCommand: pip install -r requirements.txt
    startCommand: python -m services.api.export_worker
    envVars:
      - key: APP_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: valhalla-prod
          property: internalConnectionString
      - key: WEWEB_SHARED_SECRET
        value: CHANGE_ME
      - key: S3_ENDPOINT
        value: https://YOUR-S3-ENDPOINT
      - key: S3_REGION
        value: us-east-1
      - key: S3_BUCKET
        value: valhalla-exports
      - key: S3_ACCESS_KEY_ID
        value: CHANGE_ME
      - key: S3_SECRET_ACCESS_KEY
        value: CHANGE_ME
